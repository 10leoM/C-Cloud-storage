# WebMem C++云存储项目 - 架构与文件分析文档

## 项目概览

WebMem是一个基于C++开发的高性能云存储项目，采用自研的MyMuduo网络库实现，提供完整的用户注册、登录、文件上传、下载、分享等功能。项目完全使用C++后端，配合简洁的Web前端，实现了一个功能完整的网络云盘系统。

### 核心特性
- **高性能网络库**：基于事件驱动的MyMuduo网络库，支持高并发
- **用户系统**：完整的用户注册、登录、会话管理
- **文件管理**：文件上传、下载、删除、列表展示
- **文件分享**：支持多种分享模式（公开、私有、需提取码、指定用户）
- **断点续传**：支持HTTP Range请求，实现大文件分块传输
- **数据库集成**：使用MySQL进行数据持久化
- **前后端分离**：RESTful API设计，前端通过AJAX调用

## 项目架构

### 整体架构图
```
┌─────────────────┐    HTTP/HTTPS    ┌─────────────────┐
│   Web浏览器     │ ◄──────────────► │   C++后端服务器  │
│   (HTML/CSS/JS) │                  │   (MyMuduo网络库)│
└─────────────────┘                  └─────────────────┘
                                              │
                                              │ SQL查询
                                              ▼
                                     ┌─────────────────┐
                                     │   MySQL数据库   │
                                     │   (用户/文件信息)│
                                     └─────────────────┘
                                              │
                                              │ 文件读写
                                              ▼
                                     ┌─────────────────┐
                                     │  服务器文件系统  │
                                     │   (实际文件存储) │
                                     └─────────────────┘
```

### 技术栈
- **后端**: C++17, 自研MyMuduo网络库, MySQL
- **前端**: HTML5, CSS3, JavaScript (ES6+)
- **构建系统**: CMake
- **数据库**: MySQL 8.0+
- **依赖库**: jsoncpp, mysql-client

## 目录结构分析

### 根目录文件
```
WebMem/
├── CMakeLists.txt                    # 主构建文件
├── README.md                         # 项目说明
├── DevelopmentPlan.md               # 开发计划文档
├── file_manager.sql                 # 数据库初始化脚本
└── docs/                           # 文档目录
```

### 核心模块

#### 1. base/ - 基础设施模块
```
base/
├── AsyncLogging.*                   # 异步日志系统
├── Atomic.h                         # 原子操作封装
├── BlockingQueue.h                  # 阻塞队列
├── BoundedBlockingQueue.h           # 有界阻塞队列
├── Condition.*                      # 条件变量封装
├── CountDownLatch.*                 # 倒计时门闩
├── CurrentThread.*                  # 当前线程信息
├── Date.*                          # 日期时间处理
├── Exception.*                      # 异常处理
├── FileUtil.*                       # 文件操作工具
├── LogFile.*                        # 日志文件管理
├── Logging.*                        # 日志系统核心
├── LogStream.*                      # 日志流
├── Mutex.h                         # 互斥锁封装
├── noncopyable.h                   # 不可复制基类
├── ProcessInfo.*                    # 进程信息
├── Singleton.h                      # 单例模式
├── StringPiece.h                    # 字符串片段
├── Thread.*                         # 线程封装
├── ThreadLocal.h                    # 线程局部存储
├── ThreadLocalSingleton.h           # 线程局部单例
├── ThreadPool.*                     # 线程池
├── Timestamp.*                      # 时间戳
├── TimeZone.*                       # 时区处理
├── Types.h                         # 基础类型定义
├── Version.h                       # 版本信息
└── WeakCallback.h                  # 弱回调
```

**职责**：提供网络库的基础设施，包括线程管理、日志系统、同步原语、时间处理等核心组件。

#### 2. net/ - 网络核心模块
```
net/
├── Acceptor.*                       # 接受器，处理新连接
├── Buffer.*                         # 缓冲区管理
├── Callbacks.h                      # 回调函数定义
├── Channel.*                        # 通道，封装文件描述符
├── Connector.*                      # 连接器，主动连接
├── EventLoop.*                      # 事件循环核心
├── EventLoopThread.*                # 事件循环线程
├── EventLoopThreadPool.*            # 事件循环线程池
├── HttpContext.*                    # HTTP上下文，解析HTTP请求
├── HttpRequest.h                    # HTTP请求封装
├── HttpResponse.h                   # HTTP响应封装
├── HttpServer.*                     # HTTP服务器
├── InetAddress.*                    # 网络地址封装
├── Poller.*                         # IO多路复用抽象
├── RouteTrie.*                      # 路由树实现
├── Socket.*                         # Socket封装
├── SocketsOps.*                     # Socket操作函数
├── TcpClient.*                      # TCP客户端
├── TcpConnection.*                  # TCP连接管理
├── TcpServer.*                      # TCP服务器
├── Timer.*                          # 定时器
├── TimerId.h                        # 定时器ID
├── TimerQueue.*                     # 定时器队列
└── poller/                         # IO多路复用实现
    ├── DefaultPoller.cc             # 默认Poller选择
    ├── EPollPoller.*                # epoll实现
    └── PollPoller.*                 # poll实现
```

**职责**：实现网络通信的核心功能，包括TCP服务器、HTTP协议处理、事件驱动模型等。

#### 3. application/ - 应用程序模块
```
application/
├── http_upload.cc                   # 主应用程序，文件服务器实现
├── route_test.cc                    # 路由测试程序
├── index.html                       # 主页面
├── register.html                    # 注册页面
├── share.html                       # 分享页面
├── player.js                        # 播放器脚本
├── favicon.ico                      # 网站图标
└── logo.png                        # 项目Logo
```

**职责**：实现具体的业务逻辑，包括用户管理、文件操作、页面服务等。

## 核心文件详细分析

### 1. http_upload.cc - 核心应用程序

这是整个项目的核心文件，实现了完整的文件服务器功能：

#### 主要类结构：

##### FileUploadContext 类
- **作用**：管理文件上传过程中的状态和数据
- **功能**：
  - 文件分块写入
  - 上传状态跟踪
  - multipart/form-data解析
  - 文件完整性保证

##### FileDownContext 类
- **作用**：管理文件下载过程中的状态和数据
- **功能**：
  - 断点续传支持
  - 分块读取大文件
  - HTTP Range请求处理
  - 下载进度跟踪

##### HttpUploadHandler 类
- **作用**：HTTP请求处理器，整个应用的核心控制器
- **主要功能模块**：

**路由系统**：
```cpp
void initRoutes() {
    // 公开路由（无需登录）
    addRoute("/register", HttpRequest::kPost, &HttpUploadHandler::handleRegister);
    addRoute("/login", HttpRequest::kPost, &HttpUploadHandler::handleLogin);
    addRoute("/share/([^/]+)", HttpRequest::kGet, &HttpUploadHandler::handleShareAccess);
    
    // 认证路由（需要登录）
    addRoute("/upload", HttpRequest::kPost, &HttpUploadHandler::handleFileUpload);
    addRoute("/files", HttpRequest::kGet, &HttpUploadHandler::handleListFiles);
    addRoute("/download/([^/]+)", HttpRequest::kGet, &HttpUploadHandler::handleDownload);
    // ...更多路由
}
```

**用户管理**：
- `handleRegister()`: 用户注册，密码SHA256哈希
- `handleLogin()`: 用户登录，会话管理
- `validateSession()`: 会话验证
- `handleLogout()`: 用户登出

**文件操作**：
- `handleFileUpload()`: 文件上传，支持大文件分块
- `handleDownload()`: 文件下载，支持断点续传
- `handleListFiles()`: 文件列表展示
- `handleDelete()`: 文件删除

**文件分享**：
- `handleShareFile()`: 创建文件分享
- `handleShareAccess()`: 访问分享文件
- `handleShareDownload()`: 下载分享文件
- `handleShareInfo()`: 获取分享信息

**数据库操作**：
- MySQL连接管理
- 用户表、文件表、分享表的CRUD操作
- SQL注入防护

### 2. MyMuduo网络库核心组件

#### EventLoop.h/cc - 事件循环
- **作用**：网络库的核心，实现Reactor模式
- **功能**：
  - IO事件分发
  - 定时器管理
  - 线程间通信
  - 回调函数执行

#### TcpServer.h/cc - TCP服务器
- **作用**：高层次的TCP服务器封装
- **功能**：
  - 监听端口
  - 连接管理
  - 多线程支持
  - 回调函数设置

#### HttpServer.h/cc - HTTP服务器
- **作用**：基于TcpServer的HTTP协议实现
- **功能**：
  - HTTP请求解析
  - HTTP响应生成
  - Keep-Alive支持
  - 异步请求处理

#### HttpContext.h/cc - HTTP上下文
- **作用**：HTTP请求解析状态机
- **功能**：
  - 请求行解析
  - 头部解析
  - Body解析（支持Content-Length和Chunked）
  - 大文件上传优化

#### Buffer.h/cc - 缓冲区
- **作用**：高效的网络IO缓冲区
- **功能**：
  - 自动扩容
  - 零拷贝优化
  - 二进制数据支持

### 3. 数据库设计

#### file_manager.sql - 数据库schema
```sql
-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(64) NOT NULL,        -- SHA256哈希
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 会话表
CREATE TABLE sessions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(32) NOT NULL UNIQUE,
    user_id INT NOT NULL,
    username VARCHAR(50) NOT NULL,
    expire_time TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 文件表
CREATE TABLE files (
    id INT PRIMARY KEY AUTO_INCREMENT,
    filename VARCHAR(255) NOT NULL,           -- 服务器文件名
    original_filename VARCHAR(255) NOT NULL, -- 原始文件名
    file_size BIGINT UNSIGNED NOT NULL,
    file_type VARCHAR(50),
    user_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 文件分享表
CREATE TABLE file_shares (
    id INT PRIMARY KEY AUTO_INCREMENT,
    file_id INT NOT NULL,
    owner_id INT NOT NULL,
    shared_with_id INT,                      -- 指定用户分享
    share_type ENUM('private', 'public', 'protected', 'user') NOT NULL,
    share_code VARCHAR(32) NOT NULL,         -- 分享码
    expire_time TIMESTAMP NULL,              -- 过期时间
    extract_code VARCHAR(6),                 -- 提取码
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4. 前端页面

#### index.html - 主页面
- **功能**：
  - 文件列表展示
  - 文件上传（支持拖拽）
  - 进度条显示
  - 文件操作（下载、删除、分享）
  - 响应式设计

#### register.html - 注册页面
- **功能**：
  - 用户注册表单
  - 客户端验证
  - 密码强度检查
  - AJAX提交

#### share.html - 分享页面
- **功能**：
  - 分享文件访问
  - 提取码输入
  - 文件预览
  - 下载功能

## API接口设计

### 用户管理API
| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 用户注册 | POST | /register | 新用户注册 |
| 用户登录 | POST | /login | 用户登录获取会话 |
| 用户登出 | POST | /logout | 注销会话 |
| 用户搜索 | GET | /users/search | 搜索用户 |

### 文件管理API
| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 文件上传 | POST | /upload | 上传文件 |
| 文件列表 | GET | /files | 获取文件列表 |
| 文件下载 | GET | /download/{filename} | 下载文件 |
| 文件删除 | DELETE | /delete/{filename} | 删除文件 |
| 文件信息 | HEAD | /download/{filename} | 获取文件信息 |

### 文件分享API
| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 创建分享 | POST | /share | 创建文件分享 |
| 访问分享 | GET | /share/{code} | 访问分享链接 |
| 分享下载 | GET | /share/download/{filename} | 下载分享文件 |
| 分享信息 | GET | /share/info/{code} | 获取分享信息 |

## 技术特点与创新点

### 1. 高性能网络架构
- **事件驱动模型**：基于epoll的Reactor模式
- **多线程IO**：主线程负责Accept，工作线程处理IO
- **无锁设计**：大量使用原子操作和无锁数据结构
- **内存池优化**：减少内存分配开销

### 2. 高效的HTTP协议处理
- **流式解析**：支持大文件上传不占用过多内存
- **断点续传**：完整的HTTP Range支持
- **Keep-Alive**：连接复用提高性能
- **异步处理**：支持长时间的文件传输操作

### 3. 灵活的路由系统
- **正则表达式匹配**：支持复杂的路由模式
- **参数提取**：自动提取路径参数
- **方法过滤**：支持HTTP方法过滤
- **中间件支持**：可扩展的请求处理链

### 4. 完善的文件分享机制
- **多种分享模式**：公开、私有、加密、指定用户
- **安全控制**：提取码机制防止恶意访问
- **过期管理**：支持分享链接过期
- **权限验证**：细粒度的访问控制

### 5. 安全特性
- **密码哈希**：SHA256加密存储
- **SQL注入防护**：参数化查询
- **会话管理**：安全的会话机制
- **文件访问控制**：基于用户权限的文件访问

## 性能优化策略

### 1. 网络层优化
- **零拷贝**：减少数据复制开销
- **批量IO**：提高网络吞吐量
- **连接池**：复用数据库连接
- **缓存策略**：热点数据内存缓存

### 2. 文件处理优化
- **分块传输**：支持大文件高效传输
- **异步IO**：非阻塞的文件操作
- **内存映射**：大文件读取优化
- **压缩传输**：可选的文件压缩

### 3. 数据库优化
- **索引设计**：合理的数据库索引
- **查询优化**：高效的SQL语句
- **连接管理**：连接池复用
- **事务控制**：最小化事务范围

## 可扩展性设计

### 1. 模块化架构
- **插件化设计**：易于添加新功能
- **接口抽象**：清晰的模块边界
- **配置驱动**：灵活的配置管理

### 2. 水平扩展支持
- **负载均衡**：支持多实例部署
- **数据分片**：支持数据库分片
- **分布式存储**：可接入分布式文件系统

### 3. 功能扩展点
- **认证模块**：可替换的认证机制
- **存储后端**：可插拔的存储实现
- **协议扩展**：支持WebSocket等协议

## 部署与运维

### 1. 编译部署
```bash
mkdir build && cd build
cmake ..
make
./bin/http_upload
```

### 2. 数据库初始化
```bash
mysql -u root -p < file_manager.sql
```

### 3. 配置管理
- 数据库连接配置
- 文件存储路径配置
- 日志级别配置
- 端口监听配置

### 4. 监控指标
- 连接数统计
- 请求响应时间
- 文件传输速率
- 错误率监控

## 项目总结

WebMem项目是一个完整的C++云存储解决方案，具有以下特点：

### 优势：
1. **高性能**：基于事件驱动的网络架构，支持高并发
2. **功能完整**：包含用户管理、文件操作、分享等完整功能
3. **技术先进**：使用现代C++特性，代码质量高
4. **可扩展性**：模块化设计，易于扩展
5. **实用性强**：可直接用于生产环境

### 技术价值：
1. **网络编程**：展示了高质量的C++网络编程实践
2. **系统设计**：体现了良好的系统架构设计能力
3. **工程能力**：展现了完整的项目开发和管理能力
4. **性能优化**：包含多种性能优化策略

该项目充分展示了C++在高性能网络服务开发中的优势，是一个优秀的技术实践案例，具有很高的学习和参考价值。
